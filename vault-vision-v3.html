<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
<meta name="theme-color" content="#0ea5e9">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Vault Vision">
<title>Vault Vision ‚Äî Perp DEX Aggregator</title>
<meta name="description" content="Compare on-chain vaults across perp DEX protocols. Track TVL, APR, and performance for Hyperliquid, Drift, Lighter, and Nado vaults.">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Vault Vision ‚Äî Perp DEX Aggregator">
<meta name="twitter:description" content="Compare on-chain vaults across perp DEX protocols. Track TVL, APR, and performance for Hyperliquid, Drift, Lighter, and Nado vaults.">
<meta property="og:title" content="Vault Vision ‚Äî Perp DEX Aggregator">
<meta property="og:description" content="Compare on-chain vaults across perp DEX protocols. Track TVL, APR, and performance for Hyperliquid, Drift, Lighter, and Nado vaults.">
<meta property="og:type" content="website">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%2300d4ff;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%2300ff88;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' fill='url(%23grad)'/%3E%3Ctext x='50' y='70' font-family='-apple-system,BlinkMacSystemFont,SF Pro Display,system-ui,sans-serif' font-size='60' font-weight='700' fill='white' text-anchor='middle'%3EVV%3C/text%3E%3C/svg%3E">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%2300d4ff;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%2300ff88;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' fill='url(%23grad)'/%3E%3Ctext x='50' y='70' font-family='-apple-system,BlinkMacSystemFont,SF Pro Display,system-ui,sans-serif' font-size='60' font-weight='700' fill='white' text-anchor='middle'%3EVV%3C/text%3E%3C/svg%3E">
<style>
:root{
  --sky-50:#f0f9ff;--sky-100:#e0f2fe;--sky-200:#bae6fd;--sky-300:#7dd3fc;--sky-400:#38bdf8;--sky-500:#0ea5e9;--sky-600:#0284c7;
  --slate-50:#f8fafc;--slate-100:#f1f5f9;--slate-200:#e2e8f0;--slate-400:#94a3b8;--slate-500:#64748b;--slate-600:#475569;--slate-800:#1e293b;
  --emerald-400:#34d399;--emerald-500:#10b981;--rose-400:#fb7185;--rose-500:#f43f5e;--amber-400:#fbbf24;
  --proto-hyperliquid:#0B6B3A;--proto-drift:#FFB020;--proto-lighter:#A78BFA;--proto-nado:#0B0B0B;
  /* Theme-specific */
  --bg-body:#fafcff;--bg-card:rgba(255,255,255,0.75);--bg-card-solid:#ffffff;--border-light:rgba(148,163,184,0.25);
  --header-bg:rgba(255,255,255,0.6);--nav-bg:var(--slate-100);--nav-active-bg:#fff;
  --text-primary:var(--slate-800);--text-secondary:var(--slate-500);--text-muted:var(--slate-400);
  --table-header-bg:var(--slate-50);--table-hover-bg:var(--sky-50);
  --gradient-bg:radial-gradient(ellipse 80% 50% at 20% -20%,var(--sky-100),transparent 50%),radial-gradient(ellipse 60% 40% at 80% 0%,var(--sky-200),transparent 40%),linear-gradient(180deg,#fafcff,#f0f7ff);
  /* Gradients */
  --gradient-accent:linear-gradient(135deg,#00d4ff,#00ff88);
  --gradient-accent-alt:linear-gradient(135deg,#8b5cf6,#06b6d4);
  --gradient-positive:linear-gradient(135deg,#10b981,#34d399);
  --gradient-negative:linear-gradient(135deg,#f43f5e,#fb7185);
  --glow-accent:0 0 20px rgba(0,212,255,0.3),0 0 40px rgba(0,255,136,0.15);
}
/* Dark theme */
[data-theme="dark"]{
  --bg-body:#0a0a0f;--bg-card:rgba(30,30,40,0.8);--bg-card-solid:#1a1a24;--border-light:rgba(255,255,255,0.08);
  --header-bg:rgba(15,15,20,0.85);--nav-bg:rgba(255,255,255,0.05);--nav-active-bg:rgba(255,255,255,0.1);
  --text-primary:#f1f5f9;--text-secondary:#94a3b8;--text-muted:#64748b;
  --table-header-bg:rgba(30,30,40,0.9);--table-hover-bg:rgba(56,189,248,0.08);
  --gradient-bg:radial-gradient(ellipse 80% 50% at 20% -20%,rgba(56,189,248,0.15),transparent 50%),radial-gradient(ellipse 60% 40% at 80% 0%,rgba(139,92,246,0.12),transparent 40%),linear-gradient(180deg,#0a0a0f,#0f0f1a);
  --sky-50:rgba(56,189,248,0.08);--sky-100:rgba(56,189,248,0.12);--sky-200:rgba(56,189,248,0.18);
  --slate-50:rgba(255,255,255,0.03);--slate-100:rgba(255,255,255,0.05);--slate-200:rgba(255,255,255,0.08);
  --slate-800:#f1f5f9;
}
*{margin:0;padding:0;box-sizing:border-box}
button,a,.card,.pill,.nav-btn,.back-btn,.ext-link,.card-ext-link,.theme-toggle,.compare-item{-webkit-tap-highlight-color:transparent;touch-action:manipulation}
body{font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","SF Pro Text",system-ui,sans-serif;background:var(--bg-body);color:var(--text-primary);min-height:100vh;transition:background .3s,color .3s;padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)}
.bg{position:fixed;inset:0;z-index:-1;background:var(--gradient-bg);overflow:hidden;transition:background .5s}
.floating-apr{font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display",system-ui,sans-serif;font-weight:600;font-size:16px;color:var(--emerald-500);pointer-events:none;white-space:nowrap;z-index:1;text-shadow:0 2px 8px rgba(16,185,129,0.2);will-change:transform,opacity;transform-origin:center;display:inline-block}
.floating-apr.negative{color:var(--rose-400);text-shadow:0 2px 8px rgba(244,63,94,0.2)}
.floating-apr.high{color:#f59e0b;text-shadow:0 2px 8px rgba(245,158,11,0.2)}
.floating-apr.medium{color:#8b5cf6;text-shadow:0 2px 8px rgba(139,92,246,0.2)}
@keyframes floatUp{0%{opacity:0;transform:translateY(0) translateX(var(--drift-x,0px))}5%{opacity:.12}15%{opacity:.1}50%{opacity:.07}85%{opacity:.04}100%{opacity:0;transform:translateY(calc(-100vh - 150px)) translateX(var(--drift-x,0px))}}
@keyframes floatWobblePulse{0%{transform:translateX(0) rotate(0deg) scale(1)}12.5%{transform:translateX(6px) rotate(0.8deg) scale(1.08)}25%{transform:translateX(8px) rotate(1deg) scale(1.12)}37.5%{transform:translateX(6px) rotate(0.8deg) scale(1.15)}50%{transform:translateX(0) rotate(0deg) scale(1.15)}62.5%{transform:translateX(-6px) rotate(-0.8deg) scale(1.12)}75%{transform:translateX(-8px) rotate(-1deg) scale(1.08)}87.5%{transform:translateX(-6px) rotate(-0.8deg) scale(1.05)}100%{transform:translateX(0) rotate(0deg) scale(1)}}
@media(prefers-reduced-motion:reduce){.floating-apr{animation:none!important;display:none}}
.header{position:sticky;top:0;z-index:100;padding:16px 32px;background:var(--header-bg);backdrop-filter:blur(20px);border-bottom:1px solid var(--border-light);transition:background .3s}
.header-inner{max-width:1400px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:24px;flex-wrap:wrap}
.header-tagline{font-size:14px;font-weight:500;color:var(--text-secondary);letter-spacing:-0.01em;text-align:center;flex:1;min-width:200px}
.logo{display:flex;align-items:center;gap:8px;cursor:pointer}
.logo-icon{width:36px;height:36px;background:var(--gradient-accent);border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:14px;box-shadow:var(--glow-accent);transition:transform .2s,box-shadow .2s}
.logo:hover .logo-icon{transform:scale(1.05);box-shadow:0 0 25px rgba(0,212,255,0.4),0 0 50px rgba(0,255,136,0.2)}
.logo-text{font-weight:600;font-size:18px}.logo-text span:not(.badge){background:var(--gradient-accent);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.nav{display:flex;gap:4px;background:var(--nav-bg);padding:4px;border-radius:999px;transition:background .3s}
.nav-btn{padding:8px 16px;border:none;background:0;color:var(--text-secondary);font-size:14px;font-weight:500;border-radius:999px;cursor:pointer;transition:all .2s;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
.nav-btn:hover{color:var(--text-primary)}
.nav-btn.active{background:var(--nav-active-bg);color:var(--text-primary);box-shadow:0 2px 8px rgba(0,0,0,.06)}
/* Theme toggle */
.theme-toggle{width:40px;height:40px;border:none;background:var(--nav-bg);border-radius:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;transition:all .3s;color:var(--text-secondary)}
.theme-toggle:hover{background:var(--sky-100);transform:scale(1.05)}
[data-theme="dark"] .theme-toggle{background:rgba(255,255,255,0.05)}
[data-theme="dark"] .theme-toggle:hover{background:rgba(255,255,255,0.1)}
.main{max-width:1400px;margin:0 auto;padding:32px}
.page{display:none}.page.active{display:block}
.hero-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:48px}
.stat-card{background:var(--bg-card);border:1px solid var(--border-light);border-radius:16px;padding:24px;backdrop-filter:blur(10px);transition:all .3s;animation:fadeInUp .5s ease-out backwards}
.stat-card:nth-child(1){animation-delay:.1s}.stat-card:nth-child(2){animation-delay:.2s}.stat-card:nth-child(3){animation-delay:.3s}.stat-card:nth-child(4){animation-delay:.4s}
.stat-card:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(0,212,255,0.1)}
.stat-label{font-size:13px;color:var(--text-secondary);text-transform:uppercase;margin-bottom:8px;letter-spacing:0.5px}
.stat-value{font-size:28px;font-weight:700;color:var(--text-primary)}
.stat-value.highlight{background:var(--gradient-accent);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.stat-sub{margin-top:8px;font-size:13px;color:var(--emerald-500)}
/* Animations */
@keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideIn{from{opacity:0;transform:translateX(-10px)}to{opacity:1;transform:translateX(0)}}
@keyframes countUp{from{opacity:0;transform:scale(0.8)}to{opacity:1;transform:scale(1)}}
@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
@keyframes glow{0%,100%{box-shadow:0 0 5px rgba(0,212,255,0.3)}50%{box-shadow:0 0 20px rgba(0,212,255,0.5),0 0 30px rgba(0,255,136,0.3)}}
.section{margin-bottom:48px}
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:16px}
.section-title{font-size:20px;font-weight:600;color:var(--text-primary)}
.badge{font-size:11px;font-weight:600;padding:4px 10px;border-radius:999px;background:var(--sky-100);color:var(--sky-600);margin-left:8px;transition:all .2s}
.badge.real{background:var(--gradient-positive);color:#fff}
.badge.est{background:var(--amber-400);color:var(--slate-800)}
.badge.beta{background:linear-gradient(135deg,#f59e0b,#f97316);color:#fff;animation:pulse-beta 2s ease-in-out infinite,glow 3s ease-in-out infinite;box-shadow:0 2px 8px rgba(245,158,11,0.3)}
@keyframes pulse-beta{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.9;transform:scale(1.05)}}
.pills{display:flex;gap:8px;flex-wrap:wrap}
.pill{padding:8px 16px;background:var(--bg-card-solid);border:1px solid var(--border-light);border-radius:999px;font-size:13px;font-weight:500;color:var(--text-secondary);cursor:pointer;transition:all .2s}
.pill:hover{border-color:var(--sky-400);transform:translateY(-1px)}
.pill.active{background:var(--gradient-accent);border-color:transparent;color:#fff;box-shadow:var(--glow-accent)}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px}
.card{background:var(--bg-card);border:1px solid var(--border-light);border-radius:20px;padding:24px;cursor:pointer;transition:all .3s;backdrop-filter:blur(10px);animation:fadeInUp .5s ease-out backwards;position:relative;overflow:hidden;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
.card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(0,212,255,0.05),rgba(0,255,136,0.02));opacity:0;transition:opacity .3s}
.card:hover{transform:translateY(-6px) scale(1.01);box-shadow:0 12px 40px rgba(0,212,255,.15)}
.card:hover::before{opacity:1}
[data-theme="dark"] .card:hover{box-shadow:0 12px 40px rgba(0,212,255,.25)}
.card.protocol{border:2px solid transparent;background:linear-gradient(var(--bg-card),var(--bg-card)) padding-box,var(--gradient-accent) border-box;position:relative;overflow:visible}
.card.protocol::after{content:'‚úì Protocol';position:absolute;top:-12px;right:16px;font-size:10px;padding:4px 10px;background:var(--gradient-positive);color:#fff;border-radius:999px;font-weight:600;box-shadow:0 2px 8px rgba(16,185,129,0.3);z-index:10}
.card-header{display:flex;justify-content:space-between;margin-bottom:16px}
.card-proto{display:inline-block;padding:4px 10px;border-radius:999px;font-size:11px;font-weight:600;text-transform:uppercase;margin-bottom:8px;transition:transform .2s}
.card:hover .card-proto{transform:scale(1.05)}
.card-proto.nado{background:linear-gradient(135deg,#1a1a1a,#333);color:#fff}
.card-proto.lighter{background:linear-gradient(135deg,#f3e8ff,#e9d5ff);color:#7c3aed}
.card-proto.hyperliquid{background:linear-gradient(135deg,#0B6B3A,#10b981);color:#fff}
.card-proto.drift{background:linear-gradient(135deg,#fef3c7,#fde68a);color:#d97706}
.card-name{font-size:17px;font-weight:600;line-height:1.3;color:var(--text-primary)}
.card-sub{font-size:12px;color:var(--text-muted);margin-top:4px;font-family:monospace}
.card-apy{text-align:right;min-width:90px;padding-top:28px}
.card-apy-label{font-size:10px;color:var(--text-muted);margin-top:4px}
.card-apy-val{font-size:22px;font-weight:700;background:var(--gradient-positive);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1.2}
.card-apy-val.neg{background:var(--gradient-negative);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.card-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding-top:16px;border-top:1px solid var(--border-light);margin-top:16px}
.card-stat{text-align:center}
.card-stat-label{font-size:11px;color:var(--text-muted);text-transform:uppercase}
.card-stat-val{font-size:14px;font-weight:600;margin-top:4px;color:var(--text-primary)}
.positive{background:var(--gradient-positive);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.negative{background:var(--gradient-negative);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.data-badge{display:inline-block;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:600;text-transform:uppercase;margin-left:6px;vertical-align:middle;transition:all .2s}
.data-badge.full{background:var(--gradient-positive);color:#fff}
.data-badge.partial{background:linear-gradient(135deg,#fef3c7,#fde68a);color:#92400e}
.data-badge.mock{background:var(--slate-100);color:var(--text-muted)}
/* Live indicator */
.live-dot{display:inline-block;width:8px;height:8px;background:#10b981;border-radius:50%;margin-right:6px;animation:pulse-live 2s ease-in-out infinite}
@keyframes pulse-live{0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(16,185,129,0.4)}50%{opacity:.8;box-shadow:0 0 0 6px rgba(16,185,129,0)}}
.table-wrap{overflow-x:auto;background:var(--bg-card);border-radius:16px;border:1px solid var(--border-light);backdrop-filter:blur(10px);transition:all .3s}
table{width:100%;border-collapse:collapse;min-width:800px}
th,td{padding:14px 16px;text-align:left;border-bottom:1px solid var(--border-light);color:var(--text-primary)}
th{background:var(--table-header-bg);font-size:12px;font-weight:600;text-transform:uppercase;color:var(--text-secondary);cursor:pointer;transition:all .2s}
th:hover{background:var(--table-hover-bg)}
th.sorted{background:var(--gradient-accent);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
tbody tr{transition:all .2s}
tbody tr:hover{background:var(--table-hover-bg)}
tbody tr:last-child td{border-bottom:none}
.name-link{font-weight:600;background:var(--gradient-accent);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;cursor:pointer}
.name-link:hover{text-decoration:underline}
.compare-sel{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:32px}
.compare-item{display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg-card-solid);border:2px solid var(--border-light);border-radius:12px;cursor:pointer;font-size:13px;color:var(--text-primary);transition:all .2s}
.compare-item:hover{border-color:var(--sky-400);transform:translateY(-2px)}
.compare-item.sel{border-color:transparent;background:linear-gradient(var(--bg-card),var(--bg-card)) padding-box,var(--gradient-accent) border-box}
.compare-item .chk{width:18px;height:18px;border:2px solid var(--text-muted);border-radius:5px;display:flex;align-items:center;justify-content:center;transition:all .2s}
.compare-item.sel .chk{background:var(--gradient-accent);border-color:transparent;color:#fff}
.compare-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px}
.compare-card{background:var(--bg-card);border:1px solid var(--border-light);border-radius:16px;padding:20px;backdrop-filter:blur(10px);transition:all .3s}
.compare-card:hover{transform:translateY(-4px);box-shadow:0 8px 30px rgba(0,212,255,0.1)}
.compare-card h3{font-size:16px;margin-bottom:16px;color:var(--text-primary)}
.compare-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-light);font-size:13px}
.compare-row:last-child{border-bottom:none}
.compare-row span:first-child{color:var(--text-secondary)}
.compare-row span:last-child{font-weight:600;color:var(--text-primary)}
.back-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 18px;background:var(--nav-bg);border:1px solid var(--border-light);border-radius:999px;font-size:14px;font-weight:500;color:var(--text-secondary);cursor:pointer;margin-bottom:24px;transition:all .2s}
.back-btn:hover{background:var(--sky-100);border-color:var(--sky-300);transform:translateX(-4px)}
[data-theme="dark"] .back-btn:hover{background:rgba(56,189,248,0.1)}
.detail-header{display:flex;justify-content:space-between;align-items:flex-start;gap:32px;margin-bottom:32px;flex-wrap:wrap}
.detail-header h1{font-size:26px;margin-bottom:8px;color:var(--text-primary)}
.detail-metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:32px}
.detail-metric{background:var(--bg-card);border:1px solid var(--border-light);border-radius:16px;padding:20px;text-align:center;backdrop-filter:blur(10px)}
.detail-metric-label{font-size:12px;color:var(--text-secondary);text-transform:uppercase;margin-bottom:8px}
.detail-metric-val{font-size:22px;font-weight:700;color:var(--text-primary)}
.calc-card{background:linear-gradient(135deg,var(--sky-50),var(--bg-card-solid));border:2px solid transparent;background-clip:padding-box;border-radius:20px;padding:24px;margin-bottom:32px;position:relative}
.calc-card::before{content:'';position:absolute;inset:0;border-radius:20px;padding:2px;background:var(--gradient-accent);-webkit-mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none}
.calc-card h3{font-size:18px;margin-bottom:20px;color:var(--text-primary)}
.calc-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px}
.calc-group label{display:block;font-size:12px;font-weight:600;color:var(--text-secondary);text-transform:uppercase;margin-bottom:6px}
.calc-input{width:100%;padding:12px;border:1px solid var(--border-light);border-radius:12px;font-size:16px;background:var(--bg-card-solid);color:var(--text-primary);transition:all .2s}
.calc-input:focus{outline:none;border-color:var(--sky-400);box-shadow:0 0 0 3px rgba(56,189,248,0.15)}
[data-theme="dark"] .calc-input{background:rgba(30,30,40,0.8);border-color:rgba(255,255,255,0.1)}
[data-theme="dark"] .calc-input:focus{border-color:var(--sky-400);box-shadow:0 0 0 3px rgba(56,189,248,0.2)}
.calc-results{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-top:20px;padding-top:20px;border-top:2px solid var(--border-light)}
.calc-res{text-align:center;padding:16px;background:var(--bg-card-solid);border-radius:12px;border:1px solid var(--border-light);transition:all .2s}
[data-theme="dark"] .calc-res{background:rgba(30,30,40,0.6);border-color:rgba(255,255,255,0.08)}
.calc-res-label{font-size:11px;color:var(--text-secondary);text-transform:uppercase}
.calc-res-val{font-size:22px;font-weight:700;margin-top:4px;color:var(--text-primary)}
.calc-res-val.profit{background:var(--gradient-positive);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.calc-res-val.loss{background:var(--gradient-negative);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.charts-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-bottom:32px}
.chart-card{background:var(--bg-card);border:1px solid var(--border-light);border-radius:20px;padding:20px;backdrop-filter:blur(10px)}
.chart-card h3{font-size:15px;margin-bottom:16px;display:flex;align-items:center;gap:8px;color:var(--text-primary)}
.chart-wrap{height:200px;position:relative}
.chart-wrap canvas{width:100%!important;height:100%!important}
.risk-factors{display:flex;flex-direction:column;gap:10px}
.risk-row{display:flex;align-items:center;gap:10px;font-size:12px}
.risk-row>span:first-child{width:90px;color:var(--slate-500)}
.risk-bar{flex:1;height:8px;background:var(--slate-100);border-radius:4px;overflow:hidden}
.risk-fill{height:100%;border-radius:4px;transition:width .3s}
.risk-val{width:60px;text-align:right;font-weight:600;font-size:11px}
.ext-link{display:inline-flex;align-items:center;gap:4px;padding:6px 12px;background:var(--sky-50);border:1px solid var(--sky-200);border-radius:8px;font-size:12px;font-weight:500;color:var(--sky-600);text-decoration:none;transition:.2s}
.ext-link:hover{background:var(--sky-100);border-color:var(--sky-300)}
.ext-link-icon{font-size:10px}
.card-ext-link{position:absolute;top:12px;right:12px;z-index:10;padding:6px 10px;background:rgba(255,255,255,0.9);border:1px solid var(--border-light);border-radius:8px;font-size:11px;font-weight:500;color:var(--sky-600);text-decoration:none;transition:.2s;display:flex;align-items:center;gap:4px}
.card-ext-link:hover{background:var(--sky-50);border-color:var(--sky-300)}
[data-theme="dark"] .card-ext-link{background:rgba(30,30,40,0.9);color:var(--sky-400);border-color:rgba(255,255,255,0.1)}
[data-theme="dark"] .card-ext-link:hover{background:rgba(56,189,248,0.15);border-color:var(--sky-400)}
.card{position:relative}
.official-link-section{background:var(--slate-50);border:1px solid var(--border-light);border-radius:12px;padding:16px;margin-bottom:24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.official-link-info{display:flex;flex-direction:column;gap:4px}
.official-link-label{font-size:12px;color:var(--slate-500);text-transform:uppercase}
.official-link-url{font-size:14px;font-weight:500}
.link-badge{font-size:10px;padding:2px 6px;border-radius:4px;background:var(--amber-400);color:var(--slate-800);margin-left:8px}
.link-actions{display:flex;gap:8px}
.footer{margin-top:64px;padding:32px;text-align:center;color:var(--text-muted);font-size:13px;border-top:1px solid var(--border-light);transition:all .3s}
/* Vault page enhanced styles */
.detail-metric{transition:transform .2s ease,box-shadow .2s ease,border-color .2s ease}
.detail-metric:hover{transform:scale(1.01);box-shadow:0 8px 24px rgba(14,165,233,.12)}
.detail-metric.proto-hyperliquid:hover{border-color:var(--proto-hyperliquid);box-shadow:0 8px 24px rgba(11,107,58,.2)}
.detail-metric.proto-drift:hover{border-color:var(--proto-drift);box-shadow:0 8px 24px rgba(255,176,32,.2)}
.detail-metric.proto-lighter:hover{border-color:var(--proto-lighter);box-shadow:0 8px 24px rgba(167,139,250,.2)}
.detail-metric.proto-nado:hover{border-color:var(--proto-nado);box-shadow:0 8px 24px rgba(11,11,11,.15)}
.chart-card{transition:transform .2s ease,box-shadow .2s ease,border-color .2s ease;position:relative;overflow:visible}
.chart-card:hover{transform:translateY(-2px);box-shadow:0 12px 32px rgba(14,165,233,.1)}
.chart-card.proto-hyperliquid:hover{border-color:var(--proto-hyperliquid)}
.chart-card.proto-drift:hover{border-color:var(--proto-drift)}
.chart-card.proto-lighter:hover{border-color:var(--proto-lighter)}
.chart-card.proto-nado:hover{border-color:var(--proto-nado)}
.ext-link{transition:all .2s ease}
.ext-link.proto-hyperliquid{background:rgba(11,107,58,.1);border-color:rgba(11,107,58,.3);color:#0B6B3A}
.ext-link.proto-hyperliquid:hover{background:rgba(11,107,58,.2);border-color:var(--proto-hyperliquid)}
.ext-link.proto-drift{background:rgba(255,176,32,.1);border-color:rgba(255,176,32,.3);color:#d99a00}
.ext-link.proto-drift:hover{background:rgba(255,176,32,.2);border-color:var(--proto-drift)}
.ext-link.proto-lighter{background:rgba(167,139,250,.1);border-color:rgba(167,139,250,.3);color:#8b5cf6}
.ext-link.proto-lighter:hover{background:rgba(167,139,250,.2);border-color:var(--proto-lighter)}
.ext-link.proto-nado{background:rgba(11,11,11,.08);border-color:rgba(11,11,11,.25);color:#1a1a1a}
.ext-link.proto-nado:hover{background:rgba(11,11,11,.15);border-color:var(--proto-nado)}
/* Animated number styles */
.anim-num{display:inline-block;font-variant-numeric:tabular-nums}
/* Risk gauge */
.risk-gauge-wrap{display:flex;flex-direction:column;align-items:center;padding:20px 0}
.risk-gauge{position:relative;width:160px;height:160px}
.risk-gauge svg{transform:rotate(-90deg)}
.risk-gauge-bg{fill:none;stroke:var(--slate-100);stroke-width:12}
.risk-gauge-fill{fill:none;stroke-width:12;stroke-linecap:round;transition:stroke-dashoffset .8s cubic-bezier(.4,0,.2,1),stroke .3s}
.risk-gauge-center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.risk-gauge-score{font-size:42px;font-weight:700;line-height:1}
.risk-gauge-max{font-size:16px;color:var(--slate-400)}
.risk-gauge-label{font-size:13px;font-weight:600;margin-top:8px;padding:4px 12px;border-radius:999px}
.risk-gauge-label.low{background:rgba(16,185,129,.15);color:#059669}
.risk-gauge-label.moderate{background:rgba(251,191,36,.15);color:#d97706}
.risk-gauge-label.high{background:rgba(244,63,94,.15);color:#e11d48}
/* Risk breakdown enhanced */
.risk-breakdown{margin-top:20px;overflow:visible}
.risk-breakdown-row{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border-light);overflow:visible;position:relative}
.risk-breakdown-row:last-child{border-bottom:none}
.risk-breakdown-label{width:100px;font-size:12px;color:var(--text-secondary);font-weight:500}
.risk-breakdown-bar{flex:1;height:8px;background:var(--slate-100);border-radius:4px;overflow:hidden;position:relative}
.risk-breakdown-fill{height:100%;border-radius:4px;transition:width .6s cubic-bezier(.4,0,.2,1)}
.risk-breakdown-val{width:80px;text-align:right;font-size:12px;font-weight:600}
/* Chart tooltip */
.chart-tooltip{position:absolute;background:rgba(30,41,59,.95);color:#fff;padding:8px 12px;border-radius:8px;font-size:12px;pointer-events:none;opacity:0;transition:opacity .15s;z-index:100;white-space:nowrap}
.chart-tooltip.visible{opacity:1}
.chart-tooltip-date{color:var(--slate-400);font-size:10px;margin-bottom:2px}
.chart-tooltip-value{font-weight:600}
/* Chart last point glow */
.chart-glow{position:absolute;width:12px;height:12px;border-radius:50%;animation:pulse-glow 2s infinite}
@keyframes pulse-glow{0%,100%{opacity:.6;transform:scale(1)}50%{opacity:1;transform:scale(1.3)}}
/* Fade in animation for sections */
.fade-in{animation:fadeIn .4s ease-out forwards}
@keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
/* ============================================
   VAULT PAGE HERO HEADER
   ============================================ */
.vault-hero{position:relative;background:var(--bg-card);border:1px solid var(--border-light);border-radius:24px;padding:28px 32px;margin-bottom:28px;overflow:hidden}
.vault-hero-inner{display:flex;justify-content:space-between;align-items:flex-start;gap:24px;flex-wrap:wrap;position:relative;z-index:2}
.vault-hero-left{flex:1;min-width:280px}
.vault-hero-title{font-size:28px;font-weight:700;margin:8px 0 4px;line-height:1.2}
.vault-hero-sub{font-size:13px;color:var(--slate-500);margin-top:6px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.vault-hero-underline{height:3px;width:120px;border-radius:2px;margin-top:12px;background:linear-gradient(90deg,var(--proto-hyperliquid),transparent);animation:underlineShimmer 3s ease-in-out infinite}
.vault-hero-underline.drift{background:linear-gradient(90deg,var(--proto-drift),transparent)}
.vault-hero-underline.lighter{background:linear-gradient(90deg,var(--proto-lighter),transparent)}
.vault-hero-underline.nado{background:linear-gradient(90deg,var(--proto-nado),transparent)}
@keyframes underlineShimmer{0%,100%{opacity:.7;width:120px}50%{opacity:1;width:180px}}
.vault-hero-stats{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.vault-hero-chip{background:var(--bg-card-solid);border:1px solid var(--border-light);border-radius:12px;padding:12px 16px;min-width:100px;text-align:center;transition:all .3s}
[data-theme="dark"] .vault-hero-chip{background:rgba(30,30,40,0.8);border-color:rgba(255,255,255,0.1)}
.vault-hero-chip-label{font-size:10px;color:var(--text-muted);text-transform:uppercase;margin-bottom:4px}
.vault-hero-chip-val{font-size:18px;font-weight:700;color:var(--text-primary)}
.vault-hero-btn{display:inline-flex;align-items:center;gap:6px;padding:12px 20px;border-radius:12px;font-size:14px;font-weight:600;color:#fff;text-decoration:none;transition:all .2s ease;margin-top:8px}
.vault-hero-btn:hover{transform:translateY(-1px);filter:brightness(1.1)}
.vault-hero-btn.hyperliquid{background:var(--proto-hyperliquid)}
.vault-hero-btn.drift{background:var(--proto-drift);color:var(--slate-800)}
.vault-hero-btn.lighter{background:var(--proto-lighter)}
.vault-hero-btn.nado{background:var(--proto-nado)}
.vault-hero-btn svg{width:14px;height:14px}
/* ============================================
   ANIMATED BACKGROUND BLOBS (vault page only)
   ============================================ */
.vault-bg-blobs{position:absolute;inset:0;overflow:hidden;pointer-events:none;z-index:0}
.vault-blob{position:absolute;border-radius:50%;filter:blur(80px);opacity:.07;animation:blobFloat 12s ease-in-out infinite}
.vault-blob-1{width:300px;height:300px;top:-80px;left:-60px}
.vault-blob-2{width:250px;height:250px;bottom:-60px;right:-40px;animation-delay:-6s;animation-duration:14s}
@keyframes blobFloat{0%,100%{transform:translate(0,0) scale(1)}33%{transform:translate(20px,10px) scale(1.05)}66%{transform:translate(-10px,20px) scale(.95)}}
/* ============================================
   CARD SHINE EFFECT (subtle sweep)
   ============================================ */
.chart-card.with-shine::before{content:'';position:absolute;top:0;left:-100%;width:60%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.15),transparent);transform:skewX(-20deg);animation:cardShine 10s ease-in-out infinite;z-index:1}
@keyframes cardShine{0%,85%,100%{left:-100%}90%{left:150%}}
/* ============================================
   RISK TAKEAWAY + TOOLTIPS
   ============================================ */
.risk-takeaway{margin-top:16px;padding:12px 16px;background:var(--slate-50);border-radius:10px;font-size:13px;color:var(--slate-600);line-height:1.5;text-align:center}
.risk-breakdown-label{position:relative;cursor:help;overflow:visible;z-index:10}
.risk-breakdown-label .info-icon{display:inline-flex;align-items:center;justify-content:center;width:14px;height:14px;border-radius:50%;background:var(--slate-200);color:var(--slate-500);font-size:9px;font-weight:700;margin-left:4px;vertical-align:middle}
.risk-tooltip{position:absolute;bottom:calc(100% + 8px);left:0;background:rgba(30,41,59,0.98);color:#fff;padding:10px 14px;border-radius:8px;font-size:12px;font-weight:400;opacity:0;visibility:hidden;transition:opacity .2s,visibility .2s;z-index:9999;pointer-events:none;min-width:200px;max-width:280px;white-space:normal;text-align:left;box-shadow:0 4px 20px rgba(0,0,0,0.3)}
.risk-tooltip::after{content:'';position:absolute;top:100%;left:24px;border:6px solid transparent;border-top-color:rgba(30,41,59,0.98)}
.risk-breakdown-label:hover .risk-tooltip,.risk-breakdown-label:focus .risk-tooltip{opacity:1;visibility:visible}
[data-theme="dark"] .risk-tooltip{background:rgba(15,23,42,0.98);border:1px solid rgba(255,255,255,0.15)}
[data-theme="dark"] .risk-tooltip::after{border-top-color:rgba(15,23,42,0.98)}
/* ============================================
   CHART VERTICAL GUIDELINE
   ============================================ */
.chart-guideline{position:absolute;top:15px;bottom:25px;width:1px;background:var(--slate-300);opacity:0;transition:opacity .1s;pointer-events:none;z-index:50}
.chart-guideline.visible{opacity:1}
.chart-guideline-dot{position:absolute;width:8px;height:8px;border-radius:50%;background:var(--slate-600);transform:translate(-50%,-50%);box-shadow:0 0 0 3px rgba(100,116,139,.2)}
/* ============================================
   SECTION HEADERS (chart grid)
   ============================================ */
.chart-section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.chart-section-header h3{display:flex;align-items:center;gap:8px;font-size:15px;margin:0}
.chart-last-update{font-size:10px;color:var(--slate-400)}
/* ============================================
   PREFERS REDUCED MOTION
   ============================================ */
@media(prefers-reduced-motion:reduce){
  .vault-blob,.vault-hero-underline,.chart-card.with-shine::before{animation:none!important}
  .fade-in{animation:none!important;opacity:1;transform:none}
  .risk-gauge-fill{transition:none!important}
  .risk-breakdown-fill{transition:none!important}
  @keyframes pulse-glow{0%,100%{opacity:.6;transform:scale(1)}}
}
@media(max-width:1024px){
  .hero-stats,.detail-metrics,.charts-grid,.calc-results{grid-template-columns:repeat(2,1fr)}
  .vault-hero-inner{flex-direction:column}
  .header-tagline{display:none}
  .main{padding:24px}
}
@media(max-width:768px){
  .header{padding:12px 16px}
  .header-inner{flex-direction:column;gap:12px}
  .nav{width:100%;justify-content:center;gap:2px}
  .nav-btn{padding:10px 14px;font-size:13px;min-height:44px}
  .hero-stats,.grid,.detail-metrics,.charts-grid,.calc-results{grid-template-columns:1fr;gap:12px}
  .vault-hero-stats{justify-content:center}
  .header-tagline{display:none}
  .main{padding:16px}
  .section{margin-bottom:32px}
  .section-header{margin-bottom:16px}
  .stat-card{padding:20px}
  .stat-value{font-size:24px}
  .card{padding:20px}
  .card-name{font-size:16px}
  .card-apy-val{font-size:20px}
  .card-stats{gap:8px;padding-top:12px;margin-top:12px}
  .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
  table{min-width:600px;font-size:13px}
  th,td{padding:10px 12px}
  .pill{padding:10px 14px;min-height:44px}
  .back-btn{padding:12px 16px;min-height:44px;font-size:14px}
  .calc-input{padding:14px;font-size:16px;min-height:44px}
  .calc-res{padding:14px}
  .calc-res-val{font-size:20px}
  .chart-card{padding:16px}
  .chart-wrap{height:180px}
  .vault-hero{padding:20px}
  .detail-metric{padding:16px}
  .detail-metric-val{font-size:20px}
  .footer{padding:24px 16px;font-size:12px}
  .logo-text{font-size:16px}
  .logo-icon{width:32px;height:32px;font-size:12px}
  .theme-toggle{width:44px;height:44px}
  .compare-item{padding:12px;min-height:44px}
  .ext-link{padding:10px 14px;min-height:44px}
  .card-ext-link{padding:8px 12px;font-size:12px;min-height:36px}
}
@media(max-width:480px){
  .header{padding:10px 12px;padding-top:max(10px,env(safe-area-inset-top))}
  .main{padding:12px}
  .hero-stats{gap:10px}
  .stat-card{padding:16px}
  .stat-value{font-size:22px}
  .stat-label{font-size:12px}
  .card{padding:16px;border-radius:16px}
  .card-name{font-size:15px}
  .card-apy-val{font-size:18px}
  .card-apy{padding-top:24px}
  .section-title{font-size:18px}
  .badge{font-size:10px;padding:3px 8px}
  .nav-btn{padding:8px 12px;font-size:12px}
  .pill{font-size:12px;padding:8px 12px}
  .table-wrap{border-radius:12px}
  th{font-size:11px;padding:8px 10px}
  td{font-size:12px;padding:8px 10px}
  .vault-hero{padding:16px;border-radius:20px}
  .detail-metric{padding:12px}
  .detail-metric-val{font-size:18px}
  .chart-card{padding:12px;border-radius:16px}
  .chart-wrap{height:160px}
  .calc-card{padding:20px;border-radius:16px}
  .calc-group label{font-size:11px}
  .calc-input{padding:12px;font-size:15px}
  .calc-res{padding:12px;border-radius:10px}
  .calc-res-label{font-size:10px}
  .calc-res-val{font-size:18px}
}
@media(max-width:768px) and (orientation:landscape){
  .header{padding:8px 16px}
  .main{padding:16px}
  .hero-stats{grid-template-columns:repeat(2,1fr);gap:12px}
  .vault-hero-stats{flex-wrap:wrap}
  .chart-wrap{height:200px}
}
@media(max-width:480px) and (orientation:landscape){
  .header{padding:6px 12px}
  .main{padding:12px}
  .hero-stats{grid-template-columns:repeat(4,1fr);gap:8px}
  .stat-card{padding:12px}
  .stat-value{font-size:18px}
  .stat-label{font-size:11px}
  .chart-wrap{height:150px}
}
</style>
</head>
<body>
<div class="bg"></div>
<header class="header"><div class="header-inner">
<div class="logo" onclick="nav('dashboard')"><div class="logo-icon">VV</div><div class="logo-text">Vault<span>Vision</span><span class="badge beta">BETA</span></div></div>
<div class="header-tagline">Compare on-chain vaults across perp protocols</div>
<div style="display:flex;align-items:center;gap:12px">
<nav class="nav" id="mainNav"><button class="nav-btn active" data-p="dashboard">Dashboard</button><button class="nav-btn" data-p="analytics">Analytics</button><button class="nav-btn" data-p="compare">Compare</button></nav>
<button class="theme-toggle" id="themeToggle" title="Toggle theme">üåô</button>
</div>
</div></header>
<main class="main">
<div class="page active" id="pg-dashboard">
<section class="hero-stats"><div class="stat-card"><div class="stat-label">Total TVL</div><div class="stat-value highlight" id="sTvl">$0</div><div class="stat-sub">Across all protocols</div></div><div class="stat-card"><div class="stat-label">Best APR</div><div class="stat-value" id="sApr">0%</div><div class="stat-sub" id="sAprV">-</div></div><div class="stat-card"><div class="stat-label">Active Vaults</div><div class="stat-value" id="sCnt">0</div><div class="stat-sub" id="sCntS">-</div></div><div class="stat-card"><div class="stat-label">Protocols</div><div class="stat-value">4</div><div class="stat-sub">Nado ¬∑ Lighter ¬∑ HL ¬∑ Drift</div></div></section>
<section class="section"><div class="section-header"><h2 class="section-title">Protocol Vaults<span class="badge">Official</span></h2></div><div class="grid" id="protoGrid"></div></section>
<section class="section"><div class="section-header"><h2 class="section-title">User Vaults<span class="badge">Community</span></h2><div class="pills" id="dashPills"></div></div><div class="grid" id="userGrid"></div></section>
<section class="section" id="bestRiskSection"><div class="section-header"><h2 class="section-title">Best Risk-Adjusted<span class="badge">Return/Risk</span></h2></div><div class="table-wrap"><table id="bestRiskTable"><thead><tr><th>#</th><th>Vault</th><th>Protocol</th><th>Score</th><th>Risk</th><th>Return</th><th>TVL</th></tr></thead><tbody id="bestRiskTbody"></tbody></table></div></section>
</div>
<div class="page" id="pg-analytics"><section class="section"><div class="section-header"><h2 class="section-title">Vault Analytics<span class="badge">Rankings</span></h2></div><div class="pills" id="anaPills" style="margin-bottom:24px"></div><div class="table-wrap"><table id="anaTable"><thead><tr><th data-s="rank">#</th><th data-s="vault_name">Vault</th><th data-s="protocol">Protocol</th><th>Data</th><th data-s="tvl_usd" class="sorted">TVL ‚Üì</th><th data-s="apy">APR ‚Üì</th><th data-s="age_days">Age ‚Üì</th><th data-s="r30">30D ‚Üì</th><th data-s="risk_score">Risk ‚Üì</th><th>Action</th></tr></thead><tbody id="anaTbody"></tbody></table></div></section></div>
<div class="page" id="pg-compare"><section class="section"><div class="section-header"><h2 class="section-title">Compare Vaults<span class="badge">Select 2-4</span></h2></div><div class="compare-sel" id="compSel"></div><div class="compare-grid" id="compGrid"></div></section></div>
<div class="page" id="pg-vault"><button class="back-btn" onclick="nav('analytics')">‚Üê Back to Analytics</button><div id="vaultContent"></div></div>
</main>
<footer class="footer"><span class="live-dot"></span>Live Data ‚Äî Nado ¬∑ Lighter ¬∑ Hyperliquid ¬∑ Drift<br><span id="lastUpd" style="opacity:0.7"></span></footer>
<script>
const API_BASE='';
let PV=[],UV=[];

// =============================================================================
// PROTOCOL THEME COLORS (single source of truth)
// =============================================================================
const PROTOCOL_THEMES = {
  hyperliquid: { accent: '#0B6B3A', glow: 'rgba(11,107,58,0.25)', text: '#0B6B3A' },
  drift: { accent: '#FFB020', glow: 'rgba(255,176,32,0.3)', text: '#d99a00' },
  lighter: { accent: '#A78BFA', glow: 'rgba(167,139,250,0.3)', text: '#8b5cf6' },
  nado: { accent: '#0B0B0B', glow: 'rgba(0,0,0,0.20)', text: '#1a1a1a' }
};
function getProtoTheme(proto) {
  return PROTOCOL_THEMES[proto] || PROTOCOL_THEMES.hyperliquid;
}

// =============================================================================
// RISK TAKEAWAY TEXT
// =============================================================================
function getRiskTakeaway(score) {
  if (score <= 33) return "Stable profile with established track record. Lower return volatility expected.";
  if (score <= 66) return "Balanced risk-reward. Monitor performance and market conditions.";
  return "Aggressive profile with higher volatility. Suitable for risk-tolerant investors.";
}

// =============================================================================
// ANIMATED NUMBER (always-on, uses requestAnimationFrame)
// =============================================================================
const animatedValues = new Map(); // track current animated values per element ID
function animateNumber(elementId, targetValue, opts = {}) {
  const { duration = 500, format = 'number', decimals = 2, prefix = '', suffix = '' } = opts;
  const el = document.getElementById(elementId);
  if (!el) return;
  
  const key = elementId;
  const startValue = animatedValues.has(key) ? animatedValues.get(key) : targetValue;
  const startTime = performance.now();
  
  // Cancel any previous animation for this element
  if (el._animFrame) cancelAnimationFrame(el._animFrame);
  
  function tick(now) {
    const elapsed = now - startTime;
    const progress = Math.min(elapsed / duration, 1);
    // Ease out cubic
    const eased = 1 - Math.pow(1 - progress, 3);
    const current = startValue + (targetValue - startValue) * eased;
    
    animatedValues.set(key, current);
    
    let display;
    if (format === 'usd') {
      display = prefix + fmtUsd(current) + suffix;
    } else if (format === 'pct') {
      display = prefix + (current * 100).toFixed(decimals) + '%' + suffix;
    } else if (format === 'pctSigned') {
      const p = current * 100;
      display = (p >= 0 ? '+' : '') + p.toFixed(decimals) + '%' + suffix;
    } else if (format === 'int') {
      display = prefix + Math.round(current) + suffix;
    } else {
      display = prefix + current.toFixed(decimals) + suffix;
    }
    el.textContent = display;
    
    if (progress < 1) {
      el._animFrame = requestAnimationFrame(tick);
    }
  }
  el._animFrame = requestAnimationFrame(tick);
}

// =============================================================================
// RISK SCORING LOGIC (deterministic, no AI)
// =============================================================================
function computeRiskComponents(vault) {
  const tvl = vault.tvl_usd;
  const apr = vault.apy; // stored as decimal (0.12 = 12%)
  const age = vault.age_days;
  const dq = vault.data_quality;
  
  // TVL component (higher TVL = lower risk)
  let tvlScore;
  if (tvl == null) tvlScore = 45;
  else if (tvl >= 50e6) tvlScore = 10;
  else if (tvl >= 10e6) tvlScore = 20;
  else if (tvl >= 1e6) tvlScore = 35;
  else tvlScore = 55;
  
  // APR component (higher APR = higher risk)
  let aprScore;
  const aprPct = apr != null ? Math.abs(apr) * 100 : null;
  if (aprPct == null) aprScore = 40;
  else if (aprPct <= 10) aprScore = 15;
  else if (aprPct <= 25) aprScore = 30;
  else if (aprPct <= 60) aprScore = 50;
  else aprScore = 70;
  
  // Age component (older = lower risk)
  let ageScore;
  if (age == null || age <= 0) ageScore = 40;
  else if (age >= 365) ageScore = 10;
  else if (age >= 180) ageScore = 20;
  else if (age >= 30) ageScore = 35;
  else ageScore = 55;
  
  // Data quality component
  let dqScore;
  if (dq === 'full' || dq === 'verified') dqScore = 10;
  else if (dq === 'derived') dqScore = 25;
  else if (dq === 'partial' || dq === 'simulated') dqScore = 35;
  else if (dq === 'demo' || dq === 'mock') dqScore = 45;
  else dqScore = 35;
  
  // Weighted average: tvl 0.30, apr 0.35, age 0.25, quality 0.10
  const computed = Math.round(tvlScore * 0.30 + aprScore * 0.35 + ageScore * 0.25 + dqScore * 0.10);
  const finalScore = Math.max(0, Math.min(100, computed));
  
  return {
    tvl: { score: tvlScore, label: tvlScore <= 20 ? 'Low' : tvlScore <= 40 ? 'Medium' : 'High', color: tvlScore <= 25 ? '#10b981' : tvlScore <= 45 ? '#fbbf24' : '#f43f5e' },
    apr: { score: aprScore, label: aprScore <= 25 ? 'Normal' : aprScore <= 45 ? 'Elevated' : 'High', color: aprScore <= 25 ? '#10b981' : aprScore <= 45 ? '#fbbf24' : '#f43f5e' },
    age: { score: ageScore, label: age != null ? age + 'd' : 'N/A', color: ageScore <= 25 ? '#10b981' : ageScore <= 40 ? '#fbbf24' : '#f43f5e' },
    quality: { score: dqScore, label: dq === 'full' ? 'Verified' : dq === 'partial' ? 'Partial' : dq === 'demo' || dq === 'mock' ? 'Demo' : 'Derived', color: dqScore <= 20 ? '#10b981' : dqScore <= 35 ? '#fbbf24' : '#94a3b8' },
    final: finalScore
  };
}

function getRiskLabel(score) {
  if (score <= 33) return { text: 'Low Risk', class: 'low' };
  if (score <= 66) return { text: 'Moderate Risk', class: 'moderate' };
  return { text: 'High Risk', class: 'high' };
}

function getRiskColor(score) {
  if (score <= 33) return '#10b981';
  if (score <= 66) return '#fbbf24';
  return '#f43f5e';
}

// =============================================================================
// RISK GAUGE SVG COMPONENT
// =============================================================================
function renderRiskGauge(score, protoAccent) {
  const circumference = 2 * Math.PI * 65; // radius 65
  const offset = circumference - (score / 100) * circumference;
  const color = getRiskColor(score);
  const label = getRiskLabel(score);
  
  return `
    <div class="risk-gauge-wrap">
      <div class="risk-gauge">
        <svg width="160" height="160" viewBox="0 0 160 160">
          <circle class="risk-gauge-bg" cx="80" cy="80" r="65"/>
          <circle class="risk-gauge-fill" cx="80" cy="80" r="65" 
            stroke="${color}" 
            stroke-dasharray="${circumference}" 
            stroke-dashoffset="${offset}"
            style="--target-offset:${offset}"/>
        </svg>
        <div class="risk-gauge-center">
          <span class="risk-gauge-score anim-num" id="riskScoreNum">${score}</span>
          <span class="risk-gauge-max">/100</span>
        </div>
      </div>
      <span class="risk-gauge-label ${label.class}">${label.text}</span>
    </div>
  `;
}

// =============================================================================
// RISK BREAKDOWN COMPONENT (with tooltips)
// =============================================================================
function renderRiskBreakdown(vault, riskScore) {
  // Use Risk Engine v2 components from backend if available, otherwise fallback to client-side computation
  let components;
  if (vault.risk_components && typeof vault.risk_components === 'object') {
    // Use backend Risk Engine v2 components
    const rc = vault.risk_components;
    // Match risk band logic: Low ‚â§33, Moderate 33-66, High >66
    const getLabel = (score) => {
      if (score == null) return 'N/A';
      if (score <= 33) return 'Low';
      if (score <= 66) return 'Moderate';
      return 'High';
    };
    const getColor = (score) => {
      if (score == null) return '#94a3b8';
      if (score <= 33) return '#10b981';  // green
      if (score <= 66) return '#fbbf24';   // yellow/orange
      return '#f43f5e';  // red
    };
    
    components = {
      perf: { score: rc.perf ?? null, label: getLabel(rc.perf), color: getColor(rc.perf) },
      drawdown: { score: rc.drawdown ?? null, label: getLabel(rc.drawdown), color: getColor(rc.drawdown) },
      liquidity: { score: rc.liquidity ?? null, label: getLabel(rc.liquidity), color: getColor(rc.liquidity) },
      confidence: { score: rc.confidence ?? null, label: getLabel(rc.confidence), color: getColor(rc.confidence) }
    };
  } else {
    // Fallback to legacy client-side computation
    const rc = computeRiskComponents(vault);
    components = {
      perf: { score: 50, label: 'N/A', color: '#94a3b8' }, // Not available in legacy
      drawdown: { score: 50, label: 'N/A', color: '#94a3b8' }, // Not available in legacy
      liquidity: rc.tvl,
      confidence: rc.quality
    };
  }
  
  // Get tooltip text from risk_reasons if available
  const reasons = vault.risk_reasons || {};
  const tooltips = {
    perf: reasons.volatility_30d != null ? `Volatility: ${(reasons.volatility_30d * 100).toFixed(2)}%, Worst day: ${(reasons.worst_day_30d * 100).toFixed(2)}%` : 'Performance risk based on volatility and worst day returns',
    drawdown: reasons.max_drawdown_30d != null ? `Max drawdown: ${(reasons.max_drawdown_30d * 100).toFixed(2)}%` : 'Drawdown risk based on maximum peak-to-trough decline',
    liquidity: reasons.tvl_usd != null ? `TVL: $${(reasons.tvl_usd / 1e6).toFixed(2)}M, TVL volatility: ${(reasons.tvl_volatility_30d * 100).toFixed(2)}%` : 'Liquidity risk based on TVL size and stability',
    confidence: reasons.quality_label ? `Data quality: ${reasons.quality_label}, History: ${reasons.data_points_30d || 0} points` : 'Confidence risk based on data quality and history'
  };
  
  return `
    <div class="risk-breakdown">
      <div class="risk-breakdown-row">
        <span class="risk-breakdown-label" tabindex="0">Performance Risk<span class="info-icon">?</span>
          <span class="risk-tooltip">${tooltips.perf}</span>
        </span>
        <div class="risk-breakdown-bar"><div class="risk-breakdown-fill" style="width:${components.perf.score != null ? components.perf.score : 0}%;background:${components.perf.color}"></div></div>
        <span class="risk-breakdown-val" style="color:${components.perf.color}">${components.perf.label}</span>
      </div>
      <div class="risk-breakdown-row">
        <span class="risk-breakdown-label" tabindex="0">Drawdown Risk<span class="info-icon">?</span>
          <span class="risk-tooltip">${tooltips.drawdown}</span>
        </span>
        <div class="risk-breakdown-bar"><div class="risk-breakdown-fill" style="width:${components.drawdown.score != null ? components.drawdown.score : 0}%;background:${components.drawdown.color}"></div></div>
        <span class="risk-breakdown-val" style="color:${components.drawdown.color}">${components.drawdown.label}</span>
      </div>
      <div class="risk-breakdown-row">
        <span class="risk-breakdown-label" tabindex="0">Liquidity Risk<span class="info-icon">?</span>
          <span class="risk-tooltip">${tooltips.liquidity}</span>
        </span>
        <div class="risk-breakdown-bar"><div class="risk-breakdown-fill" style="width:${components.liquidity.score != null ? components.liquidity.score : 0}%;background:${components.liquidity.color}"></div></div>
        <span class="risk-breakdown-val" style="color:${components.liquidity.color}">${components.liquidity.label}</span>
      </div>
      <div class="risk-breakdown-row">
        <span class="risk-breakdown-label" tabindex="0">Data Confidence<span class="info-icon">?</span>
          <span class="risk-tooltip">${tooltips.confidence}</span>
        </span>
        <div class="risk-breakdown-bar"><div class="risk-breakdown-fill" style="width:${components.confidence.score != null ? components.confidence.score : 0}%;background:${components.confidence.color}"></div></div>
        <span class="risk-breakdown-val" style="color:${components.confidence.color}">${components.confidence.label}</span>
      </div>
    </div>
    <div class="risk-takeaway">${getRiskTakeaway(riskScore)}</div>
  `;
}

async function loadVaults(){
  try{
    const r=await fetch(API_BASE+'/api/vaults');
    const d=await r.json();
    const vaults=d.vaults||[];
    PV=vaults.filter(v=>v.is_protocol);
    UV=vaults.filter(v=>!v.is_protocol);
    document.getElementById('lastUpd').textContent='Last updated: '+new Date(d.updated_utc*1000).toLocaleString();
    return true;
  }catch(e){console.warn('API unavailable, using fallback');useFallback();return false;}
}

// History cache keyed by vault_id + days to prevent shared data between vaults
const historyCache = {};
async function loadHistory(id,days=90){
  const cacheKey = `${id}:${days}`;
  if(historyCache[cacheKey]) return historyCache[cacheKey];
  try{
    const r=await fetch(API_BASE+'/api/vault/'+id+'/history?days='+days);
    const d=await r.json();
    // Cache with vault-specific key to prevent collisions
    historyCache[cacheKey] = d;
    return d;
  }catch(e){return{series:{tvl_usd:[],pnl_usd:[],cum_return_pct:[]},points:[],quality:{tvl:'none',pnl:'none'}};}
}

function useFallback(){
PV=[
{id:"nado-nlp",protocol:"nado",vault_name:"Nado Liquidity Provider (NLP)",vault_id:"Nado Protocol",tvl_usd:1999928,apy:2.7121,age_days:180,is_protocol:true,r30:0.226,r90:0.68,risk_score:75,source_kind:"mock",data_quality:"mock"},
{id:"lighter-llp",protocol:"lighter",vault_name:"Lighter Liquidity Provider (LLP)",vault_id:"Lighter Protocol",tvl_usd:8500000,apy:0.2214,op_fee:"0%",age_days:365,is_protocol:true,r30:0.018,r90:0.055,risk_score:55,source_kind:"mock",data_quality:"mock"},
{id:"hl-hlp",protocol:"hyperliquid",vault_name:"Hyperliquidity Provider (HLP)",vault_id:"0xdfc24b077bc1425ad1dea75bcb6f8158e10df303",tvl_usd:269001600.88,apy:0.0529,age_days:400,is_protocol:true,r30:0.0044,r90:0.013,risk_score:22,source_kind:"official_api",data_quality:"full"}
];
UV=[
{id:"lighter-edge",protocol:"lighter",vault_name:"Edge & Hedge (L/S Factors)",leader:"0x4262...Af8c",tvl_usd:3252852.52,op_fee:"20%",apy:-0.0311,age_days:126,r30:-0.003,r90:-0.009,risk_score:65,source_kind:"mock",data_quality:"mock"},
{id:"lighter-guinea",protocol:"lighter",vault_name:"Guinea Pool",leader:"0x423c...a411",tvl_usd:1175275.49,op_fee:"30%",apy:-0.8349,age_days:152,r30:-0.07,r90:-0.21,risk_score:85,source_kind:"mock",data_quality:"mock"},
{id:"lighter-nyp",protocol:"lighter",vault_name:"NYP- Not YOUR pool",leader:"0xB322...D51f",tvl_usd:1058926.54,op_fee:"10%",apy:1.1355,age_days:9,r30:0.095,r90:null,risk_score:55,source_kind:"mock",data_quality:"mock"},
{id:"lighter-alpha",protocol:"lighter",vault_name:"Alleged Alpha",leader:"0xCD7a...896e",tvl_usd:546972.70,op_fee:"25%",apy:0.10,age_days:19,r30:0.008,r90:null,risk_score:60,source_kind:"mock",data_quality:"mock"},
{id:"hl-growi",protocol:"hyperliquid",vault_name:"Growi HF",leader:"0x7789...f60d",tvl_usd:7447476.26,age_days:95,apy:0.4142,r30:0.034,r90:0.105,risk_score:45,source_kind:"official_api",data_quality:"full"},
{id:"hl-ultron",protocol:"hyperliquid",vault_name:"Ultron",leader:"0x8d3f...c056",tvl_usd:5245523.36,age_days:120,apy:0.4525,r30:0.038,r90:0.115,risk_score:42,source_kind:"official_api",data_quality:"full"},
{id:"hl-alpha",protocol:"hyperliquid",vault_name:"Alpha Momentum",leader:"TopTrader",tvl_usd:8500000,age_days:85,apy:0.32,r30:0.028,r90:0.095,risk_score:48,source_kind:"official_api",data_quality:"full"},
{id:"hl-btc",protocol:"hyperliquid",vault_name:"BTC Scalping Pro",leader:"ScalpMaster",tvl_usd:12000000,age_days:145,apy:0.55,r30:0.042,r90:0.138,risk_score:38,source_kind:"official_api",data_quality:"full"},
{id:"hl-delta",protocol:"hyperliquid",vault_name:"Delta Neutral Fund",leader:"NeutralKing",tvl_usd:4200000,age_days:60,apy:0.18,r30:0.015,r90:0.052,risk_score:52,source_kind:"official_api",data_quality:"full"},
{id:"hl-eth",protocol:"hyperliquid",vault_name:"ETH Momentum",leader:"ETHMaxi",tvl_usd:3100000,age_days:75,apy:0.28,r30:0.023,r90:0.072,risk_score:50,source_kind:"official_api",data_quality:"full"},
{id:"hl-vol",protocol:"hyperliquid",vault_name:"Volatility Harvester",leader:"VolTrader",tvl_usd:2800000,age_days:110,apy:0.38,r30:0.032,r90:0.098,risk_score:46,source_kind:"official_api",data_quality:"full"},
{id:"drift-jit",protocol:"drift",vault_name:"JIT Maker Vault",leader:"JITMaker",tvl_usd:6800000,age_days:180,apy:0.24,r30:0.022,r90:0.068,risk_score:55,source_kind:"mock",data_quality:"mock"},
{id:"drift-sol",protocol:"drift",vault_name:"SOL Perp Strategy",leader:"SolanaWhale",tvl_usd:3500000,age_days:90,apy:0.38,r30:0.035,r90:0.112,risk_score:50,source_kind:"mock",data_quality:"mock"},
{id:"drift-multi",protocol:"drift",vault_name:"Multi-Asset Neutral",leader:"DeltaGuru",tvl_usd:9200000,age_days:200,apy:0.15,r30:0.012,r90:0.042,risk_score:50,source_kind:"mock",data_quality:"mock"},
{id:"drift-fund",protocol:"drift",vault_name:"Funding Rate Arb",leader:"FundingKing",tvl_usd:4500000,age_days:65,apy:0.22,r30:0.018,r90:0.058,risk_score:55,source_kind:"mock",data_quality:"mock"},
{id:"drift-basis",protocol:"drift",vault_name:"Basis Trade Pro",leader:"BasisBoy",tvl_usd:2100000,age_days:45,apy:0.19,r30:0.016,r90:0.048,risk_score:58,source_kind:"mock",data_quality:"mock"}
];
}

const all=()=>[...PV,...UV];
const byId=id=>all().find(v=>v.id===id);
const fmtUsd=v=>{if(v==null||isNaN(v))return'N/A';if(Math.abs(v)>=1e9)return'$'+(v/1e9).toFixed(2)+'B';if(Math.abs(v)>=1e6)return'$'+(v/1e6).toFixed(2)+'M';if(Math.abs(v)>=1e3)return'$'+(v/1e3).toFixed(1)+'K';return'$'+v.toFixed(2);};
const fmtPct=v=>{if(v==null||isNaN(v))return'N/A';return(v*100).toFixed(2)+'%';};
const fmtPctS=v=>{if(v==null||isNaN(v))return'N/A';const p=v*100;return(p>=0?'+':'')+p.toFixed(2)+'%';};

let curPage='dashboard',dashF='all',anaF='all',sortK='tvl_usd',sortD='desc',selComp=new Set();

function nav(p,prm={}){
  curPage=p;
  document.querySelectorAll('#mainNav .nav-btn').forEach(b=>b.classList.toggle('active',b.dataset.p===p));
  document.querySelectorAll('.page').forEach(pg=>pg.classList.remove('active'));
  const t=document.getElementById('pg-'+p);if(t)t.classList.add('active');
  if(p==='dashboard')renderDash();
  else if(p==='analytics')renderAna();
  else if(p==='compare')renderComp();
  else if(p==='vault'&&prm.id)renderVault(prm.id);
  location.hash=p==='vault'?'vault/'+prm.id:p;
}
document.querySelectorAll('#mainNav .nav-btn').forEach(b=>b.onclick=()=>nav(b.dataset.p));
window.onhashchange=()=>{const h=location.hash.slice(1);if(h.startsWith('vault/'))nav('vault',{id:h.split('/')[1]});else nav(h||'dashboard');};

function dataQualityBadge(dq){
  const labels={full:'Verified',partial:'Partial',mock:'Demo', demo:'Demo'};
  return `<span class="data-badge ${dq||'mock'}">${labels[dq]||'Demo'}</span>`;
}
function fmtTvl(v){
  if(v==null||v===undefined) return 'N/A';
  return fmtUsd(v);
}
function fmtAge(v){
  // Use age_label if available, fallback to age_days
  if(v.age_label) return v.age_label;
  if(v.age_days!=null&&v.age_days>0) return v.age_days+'d';
  return 'N/A';
}
function extLinkBtn(v){
  if(!v.vault_url)return '';
  return `<a href="${escapeHtml(v.vault_url)}" target="_blank" rel="noopener noreferrer" class="card-ext-link" onclick="event.stopPropagation()" title="${escapeHtml(v.vault_url_label||'Open')}">Open ‚Üó</a>`;
}
function escapeHtml(s){
  if(!s)return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function protoCard(v){
  const neg=v.apy<0;
  const ageText=fmtAge(v)!=='N/A'?` ¬∑ ${fmtAge(v)}`:'';
  const dqBadge=dataQualityBadge(v.data_quality);
  return `<div class="card protocol" onclick="nav('vault',{id:'${v.id}'})">
    ${extLinkBtn(v)}
    <div class="card-header"><div><div class="card-proto ${v.protocol}">${v.protocol}${dqBadge}</div><div class="card-name">${v.vault_name}</div><div class="card-sub">${v.vault_id||''}${ageText}</div></div>
    <div class="card-apy"><div class="card-apy-label">APR</div><div class="card-apy-val ${neg?'neg':''}">${fmtPct(v.apy)}</div></div></div>
    <div class="card-stats"><div class="card-stat"><div class="card-stat-label">TVL</div><div class="card-stat-val">${fmtTvl(v.tvl_usd)}</div></div>
    <div class="card-stat"><div class="card-stat-label">30D</div><div class="card-stat-val ${(v.r30||0)>=0?'positive':'negative'}">${v.r30!=null?fmtPctS(v.r30):'N/A'}</div></div>
    <div class="card-stat"><div class="card-stat-label">90D</div><div class="card-stat-val ${(v.r90||0)>=0?'positive':'negative'}">${v.r90!=null?fmtPctS(v.r90):'N/A'}</div></div></div></div>`;
}
function userCard(v){
  const neg=v.apy<0,isL=v.protocol==='lighter';
  const riskColor=v.risk_score<=30?'positive':v.risk_score>=70?'negative':'';
  const ageText=fmtAge(v)!=='N/A'?` ¬∑ ${fmtAge(v)}`:'';
  const dqBadge=dataQualityBadge(v.data_quality);
  return `<div class="card" onclick="nav('vault',{id:'${v.id}'})">
    ${extLinkBtn(v)}
    <div class="card-header"><div><div class="card-proto ${v.protocol}">${v.protocol}${dqBadge}</div><div class="card-name">${v.vault_name}</div><div class="card-sub">${isL?'Operator':'Leader'}: ${v.leader||''}${ageText}</div></div>
    <div class="card-apy"><div class="card-apy-label">APR</div><div class="card-apy-val ${neg?'neg':''}">${fmtPct(v.apy)}</div></div></div>
    <div class="card-stats"><div class="card-stat"><div class="card-stat-label">TVL</div><div class="card-stat-val">${fmtTvl(v.tvl_usd)}</div></div>
    <div class="card-stat"><div class="card-stat-label">Risk</div><div class="card-stat-val ${riskColor}">${v.risk_score!=null?v.risk_score+'/100':'N/A'}</div></div>
    <div class="card-stat"><div class="card-stat-label">30D</div><div class="card-stat-val ${(v.r30||0)>=0?'positive':'negative'}">${v.r30!=null?fmtPctS(v.r30):'N/A'}</div></div></div></div>`;
}
function renderDash(){
  const a=all(),tvl=a.reduce((s,v)=>s+(v.tvl_usd||0),0),best=a.reduce((b,v)=>(v.apy||0)>(b.apy||0)?v:b,a[0]);
  document.getElementById('sTvl').textContent=fmtUsd(tvl);
  document.getElementById('sApr').textContent=fmtPct(best?.apy);
  document.getElementById('sAprV').textContent=best?.vault_name||'-';
  document.getElementById('sCnt').textContent=a.length;
  document.getElementById('sCntS').textContent=PV.length+' Protocol ¬∑ '+UV.length+' User';
  document.getElementById('protoGrid').innerHTML=PV.sort((a,b)=>b.tvl_usd-a.tvl_usd).map(protoCard).join('');
  const protos=['all',...new Set(UV.map(v=>v.protocol))];
  document.getElementById('dashPills').innerHTML=protos.map(p=>`<button class="pill ${dashF===p?'active':''}" data-f="${p}">${p==='all'?'All':p}</button>`).join('');
  document.querySelectorAll('#dashPills .pill').forEach(b=>{b.onclick=()=>{dashF=b.dataset.f;renderDash();};});
  let flt=dashF==='all'?UV:UV.filter(v=>v.protocol===dashF);
  document.getElementById('userGrid').innerHTML=flt.sort((a,b)=>b.apy-a.apy).map(userCard).join('');
  // Render Best Risk-Adjusted section
  renderBestRisk();
}

function renderBestRisk(){
  const vaults=all().filter(v=>v.rankings?.risk_adjusted?.rank>0).sort((a,b)=>(a.rankings?.risk_adjusted?.rank||999)-(b.rankings?.risk_adjusted?.rank||999)).slice(0,10);
  const riskColor=r=>r<=30?'positive':r>=70?'negative':'';
  if(vaults.length===0){
    document.getElementById('bestRiskTbody').innerHTML='<tr><td colspan="7" style="text-align:center;opacity:0.6">No risk-adjusted rankings yet. Run fetch job.</td></tr>';
    return;
  }
  document.getElementById('bestRiskTbody').innerHTML=vaults.map(v=>{
    const rank=v.rankings?.risk_adjusted?.rank||'-';
    const score=v.rankings?.risk_adjusted?.score;
    const ret=v.r30!=null?fmtPctS(v.r30):(v.apy!=null?fmtPct(v.apy):'N/A');
    return `<tr>
      <td><strong>${rank}</strong></td>
      <td class="name-link" onclick="nav('vault',{id:'${v.id}'})">${v.vault_name}</td>
      <td><span class="card-proto ${v.protocol}">${v.protocol}</span></td>
      <td>${score!=null?score.toFixed(3):'N/A'}</td>
      <td class="${riskColor(v.risk_score)}">${v.risk_score!=null?v.risk_score+'/100':'N/A'}</td>
      <td class="${(v.r30||v.apy||0)>=0?'positive':'negative'}">${ret}</td>
      <td>${fmtTvl(v.tvl_usd)}</td>
    </tr>`;
  }).join('');
}

function renderAna(){
  const protos=['all',...new Set(all().map(v=>v.protocol))];
  document.getElementById('anaPills').innerHTML=protos.map(p=>`<button class="pill ${anaF===p?'active':''}" data-f="${p}">${p==='all'?'All':p}</button>`).join('');
  document.querySelectorAll('#anaPills .pill').forEach(b=>{b.onclick=()=>{anaF=b.dataset.f;renderAna();};});
  // Filter: exclude vaults with exclude_from_rankings=true from analytics rankings
  let vaults=anaF==='all'?all():all().filter(v=>v.protocol===anaF);
  vaults=vaults.filter(v=>!v.exclude_from_rankings);
  vaults.sort((a,b)=>{
    const gv=(v,k)=>{
      if(k==='rank'){
        // Get verified or estimated rank, unranked vaults go to end (999)
        return v.rankings?.verified_top?.rank || v.rankings?.estimated_top?.rank || 999;
      }
      if(k==='r30')return v.r30??-Infinity;
      if(k==='risk_score')return v.risk_score??-Infinity;
      return v[k]??-Infinity;
    };
    const av=gv(a,sortK),bv=gv(b,sortK);
    if(av===bv)return(b.tvl_usd||0)-(a.tvl_usd||0);
    // For rank: ascending means 1,2,3... (lower is better), descending means 999,998...
    if(sortK==='rank') return sortD==='desc'?bv-av:av-bv;
    return sortD==='desc'?bv-av:av-bv;
  });
  document.querySelectorAll('#anaTable th[data-s]').forEach(th=>{
    th.classList.toggle('sorted',th.dataset.s===sortK);
    th.textContent=th.textContent.replace(/[‚Üë‚Üì]/,'')+(th.dataset.s===sortK?(sortD==='desc'?' ‚Üì':' ‚Üë'):'');
  });
  const riskColor=r=>r<=30?'positive':r>=70?'negative':'';
  document.getElementById('anaTbody').innerHTML=vaults.map((v,i)=>{
    // Show verified_top rank if available, otherwise estimated_top, otherwise display order
    const vRank=v.rankings?.verified_top?.rank;
    const eRank=v.rankings?.estimated_top?.rank;
    const displayRank=vRank||eRank||(i+1);
    const rankBadge=vRank?'<span title="Verified Rank" style="color:#10b981">‚úì</span>':'';
    return `<tr>
    <td>${displayRank}${rankBadge}</td>
    <td class="name-link" onclick="nav('vault',{id:'${v.id}'})">${v.vault_name}</td>
    <td><span class="card-proto ${v.protocol}">${v.protocol}</span></td>
    <td>${dataQualityBadge(v.data_quality)}</td>
    <td>${fmtTvl(v.tvl_usd)}</td>
    <td class="${(v.apy||0)>=0?'positive':'negative'}">${fmtPct(v.apy)}</td>
    <td>${fmtAge(v)}</td>
    <td class="${(v.r30||0)>=0?'positive':'negative'}">${v.r30!=null?fmtPctS(v.r30):'N/A'}</td>
    <td class="${riskColor(v.risk_score)}">${v.risk_score!=null?v.risk_score+'/100':'N/A'}</td>
    <td><button class="pill" onclick="nav('vault',{id:'${v.id}'})">View</button></td>
  </tr>`;}).join('');
  document.querySelectorAll('#anaTable th[data-s]').forEach(th=>{
    th.onclick=()=>{if(sortK===th.dataset.s)sortD=sortD==='desc'?'asc':'desc';else{sortK=th.dataset.s;sortD='desc';}renderAna();};
  });
}

function renderComp(){
  const vaults=all();
  document.getElementById('compSel').innerHTML=vaults.map(v=>`<div class="compare-item ${selComp.has(v.id)?'sel':''}" data-id="${v.id}">
    <span class="chk">${selComp.has(v.id)?'‚úì':''}</span>
    <span class="card-proto ${v.protocol}">${v.protocol}</span>
    <span>${v.vault_name.length>18?v.vault_name.slice(0,18)+'‚Ä¶':v.vault_name}</span>
  </div>`).join('');
  document.querySelectorAll('.compare-item').forEach(el=>{
    el.onclick=()=>{const id=el.dataset.id;if(selComp.has(id))selComp.delete(id);else if(selComp.size<4)selComp.add(id);renderComp();};
  });
  const sel=[...selComp].map(byId).filter(Boolean);
  if(sel.length<2){document.getElementById('compGrid').innerHTML='<div style="text-align:center;padding:48px;color:var(--slate-400)">Select 2-4 vaults to compare</div>';return;}
  const riskColor=r=>r<=30?'positive':r>=70?'negative':'';
  document.getElementById('compGrid').innerHTML=sel.map(v=>`<div class="compare-card">
    <h3><span class="card-proto ${v.protocol}">${v.protocol}</span> ${v.vault_name}</h3>
    <div class="compare-row"><span>TVL</span><span>${fmtUsd(v.tvl_usd)}</span></div>
    <div class="compare-row"><span>APR</span><span class="${(v.apy||0)>=0?'positive':'negative'}">${fmtPct(v.apy)}</span></div>
    <div class="compare-row"><span>30D Return</span><span class="${(v.r30||0)>=0?'positive':'negative'}">${v.r30!=null?fmtPctS(v.r30):'N/A'}</span></div>
    <div class="compare-row"><span>Age</span><span>${v.age_days||'N/A'} days</span></div>
    <div class="compare-row"><span>Risk Score</span><span class="${riskColor(v.risk_score)}">${v.risk_score!=null?v.risk_score+'/100':'N/A'}</span></div>
    <button class="pill" style="width:100%;margin-top:16px;justify-content:center" onclick="nav('vault',{id:'${v.id}'})">View Details</button>
  </div>`).join('');
}

function drawChart(canvas,data,color,isUsd,timestamps){
  const ctx=canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  ctx.scale(dpr, dpr);
  
  const W = rect.width, H = rect.height;
  const padL = 55, padR = 15, padT = 15, padB = 25;
  const gW = W - padL - padR, gH = H - padT - padB;
  
  // Compute nice Y-axis range
  const dataMin = Math.min(...data), dataMax = Math.max(...data);
  const range = dataMax - dataMin || 1;
  const niceMin = dataMin - range * 0.05;
  const niceMax = dataMax + range * 0.05;
  const niceRange = niceMax - niceMin;
  
  // Helper to convert value to Y coordinate
  const toY = v => padT + gH - ((v - niceMin) / niceRange) * gH;
  const toX = i => padL + (i / (data.length - 1)) * gW;
  
  ctx.clearRect(0, 0, W, H);
  
  // Gradient fill under line
  const gradient = ctx.createLinearGradient(0, padT, 0, padT + gH);
  gradient.addColorStop(0, color + '25');
  gradient.addColorStop(1, color + '05');
  ctx.fillStyle = gradient;
  ctx.beginPath();
  ctx.moveTo(padL, padT + gH);
  data.forEach((v, i) => ctx.lineTo(toX(i), toY(v)));
  ctx.lineTo(toX(data.length - 1), padT + gH);
  ctx.closePath();
  ctx.fill();
  
  // Draw line
  ctx.strokeStyle = color;
  ctx.lineWidth = 2;
  ctx.lineJoin = 'round';
  ctx.lineCap = 'round';
  ctx.beginPath();
  data.forEach((v, i) => {
    const x = toX(i), y = toY(v);
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.stroke();
  
  // Last point glow
  const lastX = toX(data.length - 1), lastY = toY(data[data.length - 1]);
  ctx.beginPath();
  ctx.arc(lastX, lastY, 4, 0, Math.PI * 2);
  ctx.fillStyle = color;
  ctx.fill();
  ctx.beginPath();
  ctx.arc(lastX, lastY, 8, 0, Math.PI * 2);
  ctx.fillStyle = color + '30';
  ctx.fill();
  
  // Y-axis (always visible)
  ctx.strokeStyle = '#e2e8f0';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(padL, padT);
  ctx.lineTo(padL, padT + gH);
  ctx.stroke();
  
  // Y-axis labels (5 ticks)
  ctx.fillStyle = '#64748b';
  ctx.font = '10px system-ui';
  ctx.textAlign = 'right';
  ctx.textBaseline = 'middle';
  for (let i = 0; i <= 4; i++) {
    const v = niceMin + (niceRange * i) / 4;
    const y = toY(v);
    ctx.fillText(isUsd ? fmtUsd(v) : (v >= 0 ? '+' : '') + v.toFixed(1) + '%', padL - 6, y);
    // Grid line
    ctx.strokeStyle = '#f1f5f9';
    ctx.beginPath();
    ctx.moveTo(padL, y);
    ctx.lineTo(W - padR, y);
    ctx.stroke();
  }
  
  // X-axis labels
  ctx.fillStyle = '#94a3b8';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'top';
  ctx.fillText('90d ago', padL, H - 18);
  ctx.fillText('Today', W - padR, H - 18);
  
  // Store chart metadata for tooltip
  canvas._chartMeta = { data, color, isUsd, timestamps, toX, toY, padL, padR, padT, gW, gH, niceMin, niceRange };
}

// Enhanced chart with hover tooltip and vertical guideline
function setupChartTooltip(canvas, tooltipEl, guidelineEl) {
  if (!canvas || !tooltipEl) return;
  
  canvas.addEventListener('mousemove', e => {
    const meta = canvas._chartMeta;
    if (!meta) return;
    
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    // Find closest data point
    const { data, isUsd, timestamps, padL, gW, toY } = meta;
    const relX = x - padL;
    if (relX < 0 || relX > gW) {
      tooltipEl.classList.remove('visible');
      if (guidelineEl) guidelineEl.classList.remove('visible');
      return;
    }
    
    const idx = Math.round((relX / gW) * (data.length - 1));
    const val = data[idx];
    const ts = timestamps ? timestamps[idx] : null;
    
    const dateStr = ts ? new Date(ts * 1000).toLocaleDateString() : `Day ${data.length - idx}`;
    const valStr = isUsd ? fmtUsd(val) : (val >= 0 ? '+' : '') + val.toFixed(2) + '%';
    
    tooltipEl.innerHTML = `<div class="chart-tooltip-date">${dateStr}</div><div class="chart-tooltip-value">${valStr}</div>`;
    tooltipEl.style.left = (x + 12) + 'px';
    tooltipEl.style.top = (y - 40) + 'px';
    tooltipEl.classList.add('visible');
    
    // Show vertical guideline
    if (guidelineEl) {
      const pointX = padL + (idx / (data.length - 1)) * gW;
      const pointY = toY(val);
      guidelineEl.style.left = pointX + 'px';
      guidelineEl.classList.add('visible');
      const dot = guidelineEl.querySelector('.chart-guideline-dot');
      if (dot) dot.style.top = pointY + 'px';
    }
  });
  
  canvas.addEventListener('mouseleave', () => {
    tooltipEl.classList.remove('visible');
    if (guidelineEl) guidelineEl.classList.remove('visible');
  });
}

function renderVault(id){
  const v=byId(id);if(!v){document.getElementById('vaultContent').innerHTML='<p>Vault not found</p>';return;}
  const isL=v.protocol==='lighter';
  const theme = getProtoTheme(v.protocol);
  const riskScore = v.risk_score != null ? v.risk_score : computeRiskComponents(v).final;
  const riskLabel = getRiskLabel(riskScore);
  
  document.getElementById('vaultContent').innerHTML=`
  <!-- Hero Header with background blobs -->
  <div class="vault-hero fade-in">
    <div class="vault-bg-blobs">
      <div class="vault-blob vault-blob-1" style="background:${theme.accent}"></div>
      <div class="vault-blob vault-blob-2" style="background:${theme.accent}"></div>
    </div>
    <div class="vault-hero-inner">
      <div class="vault-hero-left">
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
          <span class="card-proto ${v.protocol}">${v.protocol}</span>
          ${dataQualityBadge(v.data_quality)}
          ${v.source_kind?`<span class="badge">${v.source_kind.replace(/_/g,' ').toUpperCase()}</span>`:''}
        </div>
        <h1 class="vault-hero-title">${v.vault_name}</h1>
        <div class="vault-hero-sub">
          <span>${isL?'Operator':v.leader?'Leader':'ID'}: ${v.leader||v.vault_id||'‚Äî'}</span>
          <span>¬∑</span>
          <span>${fmtAge(v)} old</span>
        </div>
        <div class="vault-hero-underline ${v.protocol}"></div>
      </div>
      <div class="vault-hero-stats">
        <div class="vault-hero-chip">
          <div class="vault-hero-chip-label">TVL</div>
          <div class="vault-hero-chip-val anim-num" id="heroTvl" style="color:var(--sky-600)">${fmtTvl(v.tvl_usd)}</div>
        </div>
        <div class="vault-hero-chip">
          <div class="vault-hero-chip-label">APR</div>
          <div class="vault-hero-chip-val ${(v.apy||0)<0?'negative':'positive'}">${fmtPct(v.apy)}</div>
        </div>
        <div class="vault-hero-chip">
          <div class="vault-hero-chip-label">Risk</div>
          <div class="vault-hero-chip-val" style="color:${getRiskColor(riskScore)}">${riskScore}/100</div>
        </div>
      </div>
    </div>
    ${v.vault_url?`<a href="${escapeHtml(v.vault_url)}" target="_blank" rel="noopener noreferrer" class="vault-hero-btn ${v.protocol}">
      Open on ${v.protocol.charAt(0).toUpperCase()+v.protocol.slice(1)}
      <svg viewBox="0 0 20 20" fill="currentColor"><path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z"/><path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"/></svg>
    </a>`:''}
  </div>

  <div class="detail-metrics fade-in" style="animation-delay:.05s">
    <div class="detail-metric proto-${v.protocol}"><div class="detail-metric-label">TVL</div><div class="detail-metric-val anim-num" id="tvlNum" style="color:var(--sky-600)">${fmtTvl(v.tvl_usd)}</div></div>
    <div class="detail-metric proto-${v.protocol}"><div class="detail-metric-label">30D Return</div><div class="detail-metric-val anim-num ${(v.r30||0)>=0?'positive':'negative'}" id="r30Num">${v.r30!=null?fmtPctS(v.r30):'N/A'}</div></div>
    <div class="detail-metric proto-${v.protocol}"><div class="detail-metric-label">90D Return</div><div class="detail-metric-val anim-num ${(v.r90||0)>=0?'positive':'negative'}" id="r90Num">${v.r90!=null?fmtPctS(v.r90):'N/A'}</div></div>
    <div class="detail-metric proto-${v.protocol}"><div class="detail-metric-label">Age</div><div class="detail-metric-val anim-num" id="ageNum">${fmtAge(v)}</div></div>
  </div>

  <div class="calc-card fade-in" style="animation-delay:.1s">
    <h3>üí∞ Investment Calculator</h3>
    <div class="calc-grid">
      <div class="calc-group"><label>Investment ($)</label><input type="number" class="calc-input" id="cAmt" value="10000" min="100"></div>
      <div class="calc-group"><label>Period (days)</label><input type="number" class="calc-input" id="cDays" value="30" min="1" max="365"></div>
      <div class="calc-group"><label>APR Override (%)</label><input type="number" class="calc-input" id="cApr" value="${((v.apy||0)*100).toFixed(2)}" step="0.01"></div>
    </div>
    <div class="calc-results">
      <div class="calc-res"><div class="calc-res-label">Final Value</div><div class="calc-res-val" id="cFinal">$0</div></div>
      <div class="calc-res"><div class="calc-res-label">Profit/Loss</div><div class="calc-res-val" id="cPnl">$0</div></div>
      <div class="calc-res"><div class="calc-res-label">Daily Avg</div><div class="calc-res-val" id="cDaily">$0</div></div>
      <div class="calc-res"><div class="calc-res-label">ROI</div><div class="calc-res-val" id="cRoi">0%</div></div>
    </div>
  </div>

  <div class="charts-grid fade-in" style="animation-delay:.15s">
    <div class="chart-card proto-${v.protocol}">
      <div class="chart-section-header">
        <h3>üìà TVL History <span class="badge est" id="tvlBadge">LOADING</span></h3>
        <span class="chart-last-update" id="tvlUpdate">‚Äî</span>
      </div>
      <div class="chart-wrap">
        <canvas id="chTvl"></canvas>
        <div class="chart-guideline" id="glTvl"><div class="chart-guideline-dot"></div></div>
        <div class="chart-tooltip" id="ttTvl"></div>
      </div>
    </div>
    <div class="chart-card proto-${v.protocol}">
      <div class="chart-section-header">
        <h3>üìä Cumulative Return <span class="badge est" id="retBadge">LOADING</span></h3>
        <span class="chart-last-update" id="retUpdate">‚Äî</span>
      </div>
      <div class="chart-wrap">
        <canvas id="chRet"></canvas>
        <div class="chart-guideline" id="glRet"><div class="chart-guideline-dot"></div></div>
        <div class="chart-tooltip" id="ttRet"></div>
      </div>
    </div>
    <div class="chart-card proto-${v.protocol} with-shine">
      <div class="chart-section-header">
        <h3>üíµ PnL (Vault) <span class="badge est" id="pnlBadge">LOADING</span></h3>
        <span class="chart-last-update" id="pnlUpdate">‚Äî</span>
      </div>
      <div class="chart-wrap">
        <canvas id="chPnl"></canvas>
        <div class="chart-guideline" id="glPnl"><div class="chart-guideline-dot"></div></div>
        <div class="chart-tooltip" id="ttPnl"></div>
      </div>
    </div>
    <div class="chart-card proto-${v.protocol} with-shine">
      <h3>‚öñÔ∏è Risk Analysis</h3>
      <div style="padding:8px 0">
        ${renderRiskGauge(riskScore, theme.accent)}
        ${renderRiskBreakdown(v, riskScore)}
        ${v.op_fee?`<div style="margin-top:16px;padding:10px;background:var(--slate-50);border-radius:8px;font-size:13px;text-align:center">Operator Fee: <strong>${v.op_fee}</strong></div>`:''}
      </div>
    </div>
  </div>
  `;
  
  // Animate numbers on load (Hero + metrics)
  if (v.tvl_usd != null) {
    setTimeout(() => {
      animateNumber('heroTvl', v.tvl_usd, { format: 'usd', duration: 600 });
      animateNumber('tvlNum', v.tvl_usd, { format: 'usd', duration: 600 });
    }, 100);
  }
  if (v.age_days != null && v.age_days > 0) {
    setTimeout(() => animateNumber('ageNum', v.age_days, { format: 'int', suffix: 'd', duration: 500 }), 150);
  }
  setTimeout(() => animateNumber('riskScoreNum', riskScore, { format: 'int', duration: 700 }), 200);

  function updateCalc(){
    const amt=parseFloat(document.getElementById('cAmt').value)||0;
    const days=parseInt(document.getElementById('cDays').value)||30;
    const apr=(parseFloat(document.getElementById('cApr').value)||0)/100;
    const rate=apr/365;
    const final=amt*Math.pow(1+rate,days);
    const pnl=final-amt;
    const daily=pnl/days;
    const roi=amt>0?pnl/amt:0;
    document.getElementById('cFinal').textContent='$'+final.toFixed(2);
    document.getElementById('cPnl').textContent=(pnl>=0?'+':'-')+' $'+Math.abs(pnl).toFixed(2);
    document.getElementById('cPnl').className='calc-res-val '+(pnl>=0?'profit':'loss');
    document.getElementById('cDaily').textContent=(daily>=0?'+':'-')+' $'+Math.abs(daily).toFixed(2);
    document.getElementById('cDaily').className='calc-res-val '+(daily>=0?'profit':'loss');
    document.getElementById('cRoi').textContent=(roi>=0?'+':'')+(roi*100).toFixed(2)+'%';
    document.getElementById('cRoi').className='calc-res-val '+(roi>=0?'profit':'loss');
  }
  document.getElementById('cAmt').oninput=updateCalc;
  document.getElementById('cDays').oninput=updateCalc;
  document.getElementById('cApr').oninput=updateCalc;
  updateCalc();

  // Load unified history from API (uses new series contract with backwards compat)
  loadHistory(id,90).then(histData=>{
    const tvlBadge = document.getElementById('tvlBadge');
    const retBadge = document.getElementById('retBadge');
    const pnlBadge = document.getElementById('pnlBadge');
    
    // New contract has quality + series; old has points
    const quality = histData.quality || {};
    const series = histData.series || {};
    const points = histData.points || [];
    
    // Extract data arrays - prefer new series format, fallback to points
    let tvlData, pnlData, retData;
    
    if(series.tvl_usd && series.tvl_usd.length > 0){
      // New contract: series.tvl_usd is [[ts, value], ...]
      tvlData = series.tvl_usd.map(p => p[1]).filter(v => v > 0);
      pnlData = (series.pnl_usd || []).map(p => p[1]);
      retData = (series.cum_return_pct || []).map(p => p[1]);
    } else if(points.length > 0){
      // Old contract: points array
      tvlData = points.map(p => p.tvl_usd || 0).filter(v => v > 0);
      pnlData = points.map(p => p.pnl_usd || 0);
      retData = points.map(p => (p.return_pct || 0) * 100); // Convert to percentage
    } else {
      tvlData = [];
      pnlData = [];
      retData = [];
    }
    
    if(tvlData.length === 0 && pnlData.length === 0){
      // No data - show error state
      if(tvlBadge) { tvlBadge.textContent = 'NO DATA'; tvlBadge.className = 'badge'; }
      if(retBadge) { retBadge.textContent = 'NO DATA'; retBadge.className = 'badge'; }
      if(pnlBadge) { pnlBadge.textContent = 'NO DATA'; pnlBadge.className = 'badge'; }
      return;
    }
    
    // Determine quality from new contract or legacy flags
    const tvlQuality = quality.tvl || (histData.is_real_tvl ? 'real' : 'simulated');
    const pnlQuality = quality.pnl || (histData.is_real_pnl ? 'real' : 'simulated');
    const retQuality = quality.return || pnlQuality;
    
    // Update TVL badge
    if(tvlBadge){
      if(tvlQuality === 'real'){
        tvlBadge.textContent = 'REAL DATA';
        tvlBadge.className = 'badge real';
      }else if(tvlQuality === 'derived'){
        tvlBadge.textContent = 'DERIVED';
        tvlBadge.className = 'badge est';
      }else{
        tvlBadge.textContent = 'SIMULATED';
        tvlBadge.className = 'badge est';
      }
    }
    
    // Update Return badge
    if(retBadge){
      if(retQuality === 'real'){
        retBadge.textContent = 'REAL DATA';
        retBadge.className = 'badge real';
      }else if(retQuality === 'derived'){
        retBadge.textContent = 'DERIVED';
        retBadge.className = 'badge est';
      }else{
        retBadge.textContent = 'SIMULATED';
        retBadge.className = 'badge est';
      }
    }
    
    // Update PnL badge
    if(pnlBadge){
      if(pnlQuality === 'real'){
        pnlBadge.textContent = 'REAL PNL';
        pnlBadge.className = 'badge real';
      }else if(pnlQuality === 'derived'){
        pnlBadge.textContent = 'DERIVED';
        pnlBadge.className = 'badge est';
      }else{
        pnlBadge.textContent = 'SIMULATED';
        pnlBadge.className = 'badge est';
      }
    }
    
    // Extract timestamps if available
    let timestamps = null;
    if (series.tvl_usd && series.tvl_usd.length > 0) {
      timestamps = series.tvl_usd.map(p => p[0]);
    } else if (points.length > 0 && points[0].ts) {
      timestamps = points.map(p => p.ts);
    }
    
    // Render charts (each with independent data - no shared state)
    const chTvl = document.getElementById('chTvl');
    const chRet = document.getElementById('chRet');
    const chPnl = document.getElementById('chPnl');
    const ttTvl = document.getElementById('ttTvl');
    const ttRet = document.getElementById('ttRet');
    const ttPnl = document.getElementById('ttPnl');
    const glTvl = document.getElementById('glTvl');
    const glRet = document.getElementById('glRet');
    const glPnl = document.getElementById('glPnl');
    
    // Update "last updated" timestamps
    const lastTs = timestamps && timestamps.length > 0 ? timestamps[timestamps.length - 1] : null;
    const lastUpdateStr = lastTs ? 'Updated: ' + new Date(lastTs * 1000).toLocaleDateString() : '‚Äî';
    const tvlUpdate = document.getElementById('tvlUpdate');
    const retUpdate = document.getElementById('retUpdate');
    const pnlUpdate = document.getElementById('pnlUpdate');
    if (tvlUpdate) tvlUpdate.textContent = lastUpdateStr;
    if (retUpdate) retUpdate.textContent = lastUpdateStr;
    if (pnlUpdate) pnlUpdate.textContent = lastUpdateStr;
    
    // Use protocol accent color for charts
    const protoColor = getProtoTheme(v.protocol).accent;
    
    if(chTvl && tvlData.length > 1) {
      drawChart(chTvl, [...tvlData], protoColor, true, timestamps ? [...timestamps] : null);
      setupChartTooltip(chTvl, ttTvl, glTvl);
    }
    if(chRet && retData.length > 1) {
      const retColor = retData[retData.length-1] >= 0 ? '#10b981' : '#f43f5e';
      drawChart(chRet, [...retData], retColor, false, timestamps ? [...timestamps] : null);
      setupChartTooltip(chRet, ttRet, glRet);
    }
    if(chPnl && pnlData.length > 1) {
      const pnlColor = pnlData[pnlData.length-1] >= 0 ? '#10b981' : '#f43f5e';
      drawChart(chPnl, [...pnlData], pnlColor, true, timestamps ? [...timestamps] : null);
      setupChartTooltip(chPnl, ttPnl, glPnl);
    }
  });
}

// =============================================================================
// FLOATING APR BACKGROUND ANIMATION
// =============================================================================
function initFloatingAprs() {
  const bg = document.querySelector('.bg');
  if (!bg || window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
  
  function createFloatingApr() {
    // Create wrapper for combining transforms
    const wrapper = document.createElement('div');
    wrapper.style.position = 'absolute';
    wrapper.style.top = '100%';
    wrapper.style.left = (Math.random() * 75 + 12.5) + '%';
    wrapper.style.pointerEvents = 'none';
    wrapper.style.willChange = 'transform, opacity';
    
    const el = document.createElement('div');
    el.className = 'floating-apr';
    
    // Random APR between -40% and +160% (more variety)
    const apr = (Math.random() * 200 - 40).toFixed(1);
    const aprNum = parseFloat(apr);
    const isNeg = aprNum < 0;
    
    el.textContent = (isNeg ? '' : '+') + apr + '% APR';
    
    // Color classes based on APR value
    if (isNeg) {
      el.classList.add('negative');
    } else if (aprNum > 80) {
      el.classList.add('high'); // High APR = amber
    } else if (aprNum > 40) {
      el.classList.add('medium'); // Medium APR = purple
    }
    // Default green for moderate APR
    
    // Random diagonal drift (left or right)
    const driftAmount = (Math.random() * 100 - 50); // -50px to +50px
    wrapper.style.setProperty('--drift-x', driftAmount + 'px');
    
    // Random animation duration (10-25s for more variety)
    const duration = 10 + Math.random() * 15;
    wrapper.style.animation = `floatUp ${duration}s linear forwards`;
    el.style.animation = `floatWobblePulse ${2 + Math.random() * 2}s ease-in-out infinite`;
    
    // Random font size (12-24px for more variety)
    el.style.fontSize = (12 + Math.random() * 12) + 'px';
    
    // Random font weight (500-700)
    el.style.fontWeight = 500 + Math.random() * 200;
    
    wrapper.appendChild(el);
    bg.appendChild(wrapper);
    
    // Remove after animation
    setTimeout(() => { if(wrapper.parentNode) wrapper.remove(); }, duration * 1000 + 100);
  }
  
  // Create initial batch (more elements)
  for (let i = 0; i < 10; i++) {
    setTimeout(createFloatingApr, i * 300);
  }
  
  // Continue creating (more frequent, more elements)
  setInterval(() => {
    if (document.visibilityState === 'visible' && bg.querySelectorAll('.floating-apr').length < 20) {
      createFloatingApr();
    }
  }, 1200);
}

// =============================================================================
// TOOLTIP INIT (CSS-only, JS just for potential future enhancements)
// =============================================================================
function initTooltips() {
  // Tooltips work via CSS :hover, no JS needed
  // This function exists for potential future enhancements
}

// =============================================================================
// THEME TOGGLE
// =============================================================================
function initTheme() {
  const toggle = document.getElementById('themeToggle');
  const saved = localStorage.getItem('theme');
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  
  // Apply saved theme or system preference
  if (saved) {
    document.documentElement.setAttribute('data-theme', saved);
    toggle.textContent = saved === 'dark' ? '‚òÄÔ∏è' : 'üåô';
  } else if (prefersDark) {
    document.documentElement.setAttribute('data-theme', 'dark');
    toggle.textContent = '‚òÄÔ∏è';
  }
  
  toggle.addEventListener('click', () => {
    const current = document.documentElement.getAttribute('data-theme');
    const next = current === 'dark' ? 'light' : 'dark';
    
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
    toggle.textContent = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    
    // Add transition animation
    document.body.style.transition = 'background 0.5s, color 0.3s';
  });
}

// =============================================================================
// ANIMATED COUNTERS
// =============================================================================
function animateValue(el, start, end, duration, prefix = '', suffix = '') {
  const range = end - start;
  const startTime = performance.now();
  
  function update(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    // Easing function (ease-out)
    const easeOut = 1 - Math.pow(1 - progress, 3);
    const current = start + (range * easeOut);
    
    if (prefix === '$') {
      el.textContent = prefix + formatNum(current);
    } else {
      el.textContent = prefix + current.toFixed(1) + suffix;
    }
    
    if (progress < 1) {
      requestAnimationFrame(update);
    }
  }
  requestAnimationFrame(update);
}

function formatNum(n) {
  if (n >= 1e9) return (n/1e9).toFixed(2) + 'B';
  if (n >= 1e6) return (n/1e6).toFixed(2) + 'M';
  if (n >= 1e3) return (n/1e3).toFixed(1) + 'K';
  return n.toFixed(0);
}

// Init: load data then navigate
(async function(){
  // Initialize theme and tooltips
  initTheme();
  initTooltips();
  
  await loadVaults();
  if(PV.length===0&&UV.length===0)useFallback();
  document.getElementById('lastUpd').textContent='Last updated: '+new Date().toLocaleString();
  const h=location.hash.slice(1);
  if(h.startsWith('vault/'))nav('vault',{id:h.split('/')[1]});
  else if(['analytics','compare'].includes(h))nav(h);
  else nav('dashboard');
  
  // Start floating APR animation
  initFloatingAprs();
  
  // Animate hero stats
  setTimeout(() => {
    const tvlEl = document.getElementById('sTvl');
    const aprEl = document.getElementById('sApr');
    const cntEl = document.getElementById('sCnt');
    
    // Get current values and animate
    const tvlText = tvlEl.textContent.replace(/[$,BMK]/g, '');
    const tvlNum = parseFloat(tvlText) || 0;
    const tvlMult = tvlEl.textContent.includes('B') ? 1e9 : tvlEl.textContent.includes('M') ? 1e6 : 1e3;
    
    if (tvlNum > 0) {
      animateValue(tvlEl, 0, tvlNum * tvlMult, 1500, '$', '');
    }
  }, 500);
})();
</script>
</body>
</html>
